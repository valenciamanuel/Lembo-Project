<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detalles de la Asociación</title>
    <link rel="stylesheet" href="/fronted/public/css/pages/visualizar/visualizar.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="dashboard-container">
    <h1>Dashboard de Asociación</h1>
    <button id="editarBtn">Editar</button>

    
    <!-- Contenedor de los detalles de la Asociación en cajas -->
    <div class="details-container">
        <div class="details-grid">
            <!-- Cajas de detalles -->
            <div class="detail-box">
                <h3>Nombre</h3>
                <p id="nombreAsociacion"></p>
            </div>
            <div class="detail-box">
                <h3>Responsable</h3>
                <p id="responsable"></p>
            </div>
            <div class="detail-box">
                <h3>Descripción</h3>
                <p id="descripcion"></p>
            </div>
            <div class="detail-box">
                <h3>Inversión</h3>
                <p id="inversion"></p>
            </div>
            <div class="detail-box">
                <h3>Meta</h3>
                <p id="meta"></p>
            </div>
            <div class="detail-box">
                <h3>Inicio Producción</h3>
                <p id="inicioProduccion"></p>
            </div>
            <div class="detail-box">
                <h3>Fin Producción</h3>
                <p id="finProduccion"></p>
            </div>
            <div class="detail-box">
                <h3>Cultivo</h3>
                <p id="cultivo"></p>
            </div>
            <div class="detail-box">
                <h3>Sensores</h3>
                <p id="sensores"></p>
            </div>
            <div class="detail-box">
                <h3>Insumos</h3>
                <p id="insumos"></p>
            </div>
            <div class="detail-box">
                <h3>Ciclo Cultivo</h3>
                <p id="cicloCultivo"></p>
            </div>
        </div>
    </div>

    <!-- Contenedor de la información y gráficos organizados en cuadros -->
    <div class="dashboard-info">
        <!-- Cuadro de gráfico de Inversión vs Meta -->
        <div class="info-item">
            <h3>Inversión vs Meta</h3>
            <canvas id="inversionMetaChart"></canvas>
            <p>Descripción adicional sobre la inversión y la meta alcanzada.</p>
        </div>

        <!-- Cuadro de gráfico de Progreso de Producción -->
        <div class="info-item">
            <h3>Progreso de Producción</h3>
            <canvas id="progresoProduccionChart"></canvas>
            <p>Detalles sobre el progreso de la producción.</p>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    if (id) {
        fetch(`http://localhost:3000/asociaciones/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo cargar los detalles de la asociación');
                }
                return response.json();
            })
            .then(asociacion => {
                // Asignación de los detalles a los elementos correspondientes
                document.getElementById('nombreAsociacion').textContent = asociacion.nombre_asociacion;
                document.getElementById('responsable').textContent = asociacion.responsable;
                document.getElementById('descripcion').textContent = asociacion.descripcion;
                document.getElementById('inversion').textContent = `$${asociacion.inversion}`;
                document.getElementById('meta').textContent = `$${asociacion.meta}`;
                document.getElementById('inicioProduccion').textContent = asociacion.iniico_produccion;
                document.getElementById('finProduccion').textContent = asociacion.fin_produccion;
                document.getElementById('cultivo').textContent = asociacion.cultivo;
                document.getElementById('sensores').textContent = asociacion.sensores;
                document.getElementById('insumos').textContent = asociacion.insumos;
                document.getElementById('cicloCultivo').textContent = asociacion.ciclo_cultivo;
            })
            .catch(err => {
                console.error("Error al cargar los detalles de la asociación:", err);
            });
    } else {
        console.error('ID no proporcionado en la URL');
    }

    // Datos para los gráficos (solo ejemplo)
    const asociacionData = {
        inversion: 50000, // Ejemplo: inversión en dólares
        meta: 60000,      // Ejemplo: meta en dólares
        progreso: 75      // Ejemplo: progreso de producción en porcentaje
    };

    // Gráfico de Inversión vs Meta
    const ctxInversionMeta = document.getElementById('inversionMetaChart').getContext('2d');
    const inversionMetaChart = new Chart(ctxInversionMeta, {
        type: 'bar',
        data: {
            labels: ['Inversión', 'Meta'],
            datasets: [{
                label: 'Monto en USD',
                data: [asociacionData.inversion, asociacionData.meta],
                backgroundColor: ['#4caf50', '#ff9800'],
                borderColor: ['#388e3c', '#f57c00'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Progreso de Producción
    const ctxProgresoProduccion = document.getElementById('progresoProduccionChart').getContext('2d');
    const progresoProduccionChart = new Chart(ctxProgresoProduccion, {
        type: 'doughnut',
        data: {
            labels: ['Completado', 'Restante'],
            datasets: [{
                label: 'Progreso de Producción',
                data: [asociacionData.progreso, 100 - asociacionData.progreso],
                backgroundColor: ['#4caf50', '#f44336'],
                borderColor: '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });

    document.getElementById('editarBtn').addEventListener('click', () => {
    const editarBtn = document.getElementById('editarBtn');

    if (editarBtn.textContent === 'Editar') {
        convertirAPEditable();
        editarBtn.textContent = 'Guardar';
    } else {
        guardarCambios();
        editarBtn.textContent = 'Editar';
    }
});

function convertirAPEditable() {
    const campos = ['nombreAsociacion', 'responsable', 'descripcion', 'inversion', 'meta', 'inicioProduccion', 'finProduccion', 'cultivo', 'sensores', 'insumos', 'cicloCultivo'];
    
    campos.forEach(id => {
        const elemento = document.getElementById(id);
        const valor = elemento.textContent;
        elemento.innerHTML = `<input type="text" id="input-${id}" value="${valor}" />`;
    });
}

function guardarCambios() {
    const campos = ['nombreAsociacion', 'responsable', 'descripcion', 'inversion', 'meta', 'inicioProduccion', 'finProduccion', 'cultivo', 'sensores', 'insumos', 'cicloCultivo'];
    const datosActualizados = {};

    campos.forEach(id => {
        const input = document.getElementById(`input-${id}`);
        const valor = input.value;
        datosActualizados[id] = valor;
        document.getElementById(id).textContent = valor;
    });

    // Mapea al nombre real de la base de datos
    const payload = {
        nombre_asociacion: datosActualizados.nombreAsociacion,
        responsable: datosActualizados.responsable,
        descripcion: datosActualizados.descripcion,
        inversion: datosActualizados.inversion,
        meta: datosActualizados.meta,
        iniico_produccion: datosActualizados.inicioProduccion,
        fin_produccion: datosActualizados.finProduccion,
        cultivo: datosActualizados.cultivo,
        sensores: datosActualizados.sensores,
        insumos: datosActualizados.insumos,
        ciclo_cultivo: datosActualizados.cicloCultivo
    };

    fetch(`http://localhost:3000/asociaciones/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (!res.ok) throw new Error("Error al guardar");
        return res.json();
    })
    .then(data => {
        console.log("Asociación actualizada:", data);
        alert("Datos actualizados correctamente");
    })
    .catch(err => {
        console.error("Error al actualizar:", err);
        alert("Error al actualizar los datos");
    });
}
</script>

</body>
</html>
